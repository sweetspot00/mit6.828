---
layout: post
tags: ["数据库", "数据同步"]
title: "MySQL数据实时同步到Clickhouse的踩坑记录"
date: 2021-08-09T07:28:27+08:00
math: false
draft: false
---

### MySQL binlog实现主从数据库同步

MySQL binlog会记录所有的DML和DDL语句，问题在于binlog每七天删除一次，所以无法直接利用binlog全量同步。

#### 1. Canal-阿里开源数据同步工具

canal是我最初尝试使用的中间件，canal-server伪装成一个slave消费MySQL binlog，canal-client作为下游接收上游数据然后传给Clickhouse。实验证明canal只能处理普通insert语句，而DDL和update和delete语句均不支持。此外，在接收到DDL语句后，client端会报错停止，导致后面的数据也无法同步（不能跳过这点很坑）。综上所述，canal并不是一个能很好支持mysql数据同步到ck的中间件，其原因与ck的sql语法有一定关系。

还有一点，canal目前web ui配置管理只有server端没有client端。

#### 2. MaterializeMySQL引擎

MaterializeMySQL引擎是clickhouse自研的同步mysql的数据库引擎。2020年新的project现在刚刚merge到主分支，所以可能会有挺多问题（比如数据一致性）。总体实验下来原生同步体验很好，操作也很简单。唯一困难的是无法同步mysql已有数据库并且MaterializeMySQL引擎不支持建表。这意味着mysql和clickhouse中的表必须要同时创建。

#### 3. StreamSets

ETL工具，具像化为组件，用pipeline构建数据流向。
全量同步坑点：不设置停止组建pipeline会循环一直同步重复的数据。
功能很强大但目前需求用不到

#### 4. Bifrost

目前看来最好用的实时同步工具，包括它给的example都是mysql到clickhouse的同步。
官方文档： <https://wiki.xbifrost.com>




